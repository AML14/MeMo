# Tutorial

This step-by-step tutorial illustrates how Toradocu can be used to discover
faults in a software system under test. This tutorial covers the test of a toy
class `net.Connection` that represents a network connection. The class offers
the method `open` to establish a new connection.

1. Compile Toradocu:  `./gradlew shadowJar`

2. Move to the tutorial directory: `cd tutorial`

   The directory `tutorial/src` contains the source code of the system under test,
   while the directory `tutorial/test` contains the source code of the test
   suite.

   The method `net.Connection#open` is called by the test case `net.ConnectionTest#open`, while
   the method `net.Connection#send` is called by the test case `net.ConnectionTest#send`.

   There are several problems with this code.

   1. The method `net.Connection#open` is supposed to throw an `IllegalStateException` if invoked
      on an open connection, but it does not.

   2. The test case `net.ConnectionTest#open` does not verify that `IllegalStateException` is raised.

   3. The method `net.Connection#send` correctly throws a `NullPointerException` if invoked with an
      empty message. The test case `net.ConnectionTest#send` does not verify that
      `NullPointerException` is raised.

   Toradocu will improve the test cases, and it will reveal the problem in the code.

3. Download the libraries required to compile and run the system under test, its
   test suite, and the aspects generated by Toradocu. If `wget` is available in your
   operative systems, you can use the following commands, otherwise you have to use
   other tools to download the required libraries.
   ```
   wget -O junit-4.12.jar http://search.maven.org/remotecontent\?filepath\=junit/junit/4.12/junit-4.12.jar
   wget -O hamcrest-core-1.3.jar http://search.maven.org/remotecontent?filepath=org/hamcrest/hamcrest-core/1.3/hamcrest-core-1.3.jar
   wget -O aspectjtools-1.8.9.jar http://central.maven.org/maven2/org/aspectj/aspectjtools/1.8.9/aspectjtools-1.8.9.jar
   wget -O aspectjweaver-1.8.9.jar http://central.maven.org/maven2/org/aspectj/aspectjweaver/1.8.9/aspectjweaver-1.8.9.jar
   wget -O aspectjrt-1.8.9.jar http://central.maven.org/maven2/org/aspectj/aspectjrt/1.8.9/aspectjrt-1.8.9.jar
   ```

4. Compile the source code of the system under test: `javac src/net/Connection.java`

5. Compile and execute the test suite
   ```
   javac -cp junit-4.12.jar:src test/net/ConnectionTest.java
   java -cp junit-4.12.jar:hamcrest-core-1.3.jar:test:src org.junit.runner.JUnitCore net.ConnectionTest
   ```
   The test suite terminates with 1 failure, printing
   ```
   There was 1 failure:
   1) send(net.ConnectionTest)
   java.lang.NullPointerException
   ```

6. Generate the aspects with Toradocu in the folder `aspects`
   ```
   java -jar ../build/libs/toradocu-1.0-all.jar \
   --target-class net.Connection \
   --test-class net.ConnectionTest \
   --source-dir src \
   --class-dir src \
   --aspects-output-dir aspects
   ```
   Toradocu prints the output of its condition translation phase,
   which is a JSON data structure.

7. Compile the generated aspects and weave them into the test suite of the system under test
   ```
   javac -g -cp aspectjrt-1.8.9.jar:src:junit-4.12.jar aspects/Aspect_1.java
   java -cp aspectjtools-1.8.9.jar:aspectjweaver-1.8.9.jar:aspectjrt-1.8.9.jar:src org.aspectj.tools.ajc.Main -inpath aspects:test -outjar weaved_testsuite.jar -showWeaveInfo
   ```

8. Run the test suite augmented with Toradocu's oracles
   ```
   java -cp junit-4.12.jar:hamcrest-core-1.3.jar:src:weaved_testsuite.jar:aspectjrt-1.8.9.jar org.junit.runner.JUnitCore net.ConnectionTest
   ```
   The test suite execution terminates with one failure:

   ```
   There was 1 failure:
   1) open(net.ConnectionTest)
   java.lang.AssertionError: Triggered aspect: Aspect_1 (ConnectionTest.java:13) -> Failure: Expected exception not thrown. Expected exceptions were: java.lang.IllegalStateException
   ```

   The report says that an IllegalStateException was expected, but wrongly the method
   `net.Connection#open` did not raise any exception.

   Note also that the test `net.Connection#send` does not longer fail, since the code under test
   is correct: the method `net.Connection#send` correctly throws a `NullPointerException`.
